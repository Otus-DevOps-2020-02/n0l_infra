# n0l_infra
n0l Infra repository

#### ex.11

1. рассмотрели вырианты создания инфрструктуры с помощью плейбуков (один файл нужно задавать группы хостов к которым будет применяться этот файл через --limit и через теги --tags задания)
2. расмотрели вариант, в одном плейбуке лежит несколько сценариев (указывать нужно только теги, а нужные группы уже заложены в сценариях)
3. рассмотрели вариант с несколькими плейбуками (самый оптимальный)
4. переписал скрипт для создания динамического инвентори (теперь на выходе json c разбивкой пр группам)
5. Вместо shell скриптов в packer теперь используется ansible для устанловки пакетов
6. документация по модулям: https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html
7. документация по циклам: https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html
8. команда для запуска плейбука на хостах входящих в группу db выполняться только задачи с тегом app-tag (--check тестовый прогон плейбука): "ansible-playbook reddit_app.yml --check --tags app-tag --limit db"
9. P.S. Пути в JSON-файлах корректны, билд образов нужно производить из корня репозитория
10. P.P.S. Для WSL может понадобиться задать еще пользователя "user": "appuser"

#### ex.10

1. Создали инвентори файл
2. поработали с группами хостов
3. познакомились с модулями
4. написали простой плейбук

Строчка PLAY RECAP ok= - сколько задач выполнено changed= - сколько задач произвели изменения в системе

Задание со *

[https://medium.com/@Nklya/%D0%B4%D0%B8%D0%BD%D0%B0%D0%BC%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5-%D0%B8%D0%BD%D0%B2%D0%B5%D0%BD%D1%82%D0%BE%D1%80%D0%B8-%D0%B2-ansible-9ee880d540d6](https://medium.com/@Nklya/динамическое-инвентори-в-ansible-9ee880d540d6) 
Для работы с динамическим инвентори нужно написать скрипт, который на выходе выдает json формата как в статье Скрипт dynamic-inventory.py - ходит в gcp, парсит имена хостов и ip адреса и выдает форматированный json

#### ex.09

1. Знакомство с мета-арагументами terraform (provisioner, depends_on, count, итд)
2. Импорт существующей инфраструктуры в terraform
3. Строковые шаблоны ${}; %{}; if; for
4. Шаблоны templatefile
5. Разбиваем инфраструктуру вна отдельные файлы
6. Используем модули
7. Создаем окружения stage и prod
8. Работа с реестром модулей и хранение стейда в бакете
9. 

#### ex.08

1. Знакомство с  terraform (отсновные команды и понятия). Создание инстанса

2. Входные и выходные переменные и параметризация

3. Provisioners

4. Добавил несколько ssh ключей в коде terraform
   Для добавления нескольких ssh ключей в метаданные всего проекта, их нужно записывать в одну строку без пробелов. (пример ниже). Если через web поменять конфигурацию, затем выполнить terraform apply, то он затрет измения выполненные через web

   ```yaml
   resource "google_compute_project_metadata" "default" {
     metadata = {
       ssh-keys = "appuser:${file(var.public_key_path)}appuser1:${file("/Users/xxx/.ssh/appuser1.pub")}appuser2:${file("/Users/xxx/.ssh/appuser2.pub")}"
     }
   }
   ```

5. Описание через terraform инфраструктуры балансировщика в GCP

#### ex.07

1. Создание образа c уствновленными пакетами с  помощью packer **ubuntu16.json** (остается только задеплоить приложение)
2.  Настрока файла параметризации **variables.json**
3. Создание полностью готового образа с задеплоенным приложением
4. Команда для  GCP, которая создает VM из образа

#### ex.06

1. Создание инстанса через gcloud и настрока правил firewall
2. Созданы скрипты для настройки системы и деплоя приложения
3. Все скрипты обьединены в один startup script, который можно указать при создании инстанса

testapp_IP = 34.70.106.97
testapp_port = 9292

#### ex.05

1. Создание инстанса через GUI и настрока правил firewall

2. Добавление ssh ключа в проект

3. Подключение чере ssh  к бастион хосту и к хосту за ним. Создание алиаса для быстрого подключения

   ```bash
   $ alias someinternalhost="ssh -i ~/.ssh/appuser -A -J appuser@<ext. IP> appuser@<int. IP>"
   ```

4. Настрока OpenVPN сервера на базе pritunl

5. Настройка валидного сертификата используя сервисы https://letsencrypt.org/ и http://xip.io/ 

6. Для корректной работы:  Справа сверху Settings -> вписать в поле Lets Encrypt Domain - **35.209.112.226.xip.io**

bastion_IP = 35.209.112.226
someinternalhost_IP = 10.128.15.232

#### ex.04

1.  Настройка git hooks вариант pre-commit через https://pre-commit.com/
2. Интеграций github и slack (получение уведомлений в slack)
3. Интеграция travis ci и slack для получения результата проверки

